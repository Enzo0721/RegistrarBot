# RegistrarBot ü§ñ

<img width="1024" height="1024" alt="" src="https://github.com/user-attachments/assets/c6e0182c-c811-454e-a736-bebc5b5c7b25" />

A modern RPI Registrar chatbot built with Express.js, Socket.io, and Next.js. Provides both REST API and real-time chat functionality with AI integration.

## üöÄ Features

- **REST API** - Query the chatbot via HTTP endpoints
- **Socket.io Based Chat** - Socket.io powered chat rooms
- **Web Interface** - Modern Next.js frontend with Tailwind CSS

## üìù Development Status & Tasks

<!-- MONDAY_BOARD_START -->
| Task | Status |
|---|---|
| Environment | Working on it |
| Security Protocols | Not Started |
| LLM | Stuck |
| Database | Working on it |
| Dashboard | Not Started |
| Chatroom | Working on it |
| Multilingual | Not Started |
| Documentation & Git | Working on it |

<!-- MONDAY_BOARD_END -->

## üìÅ Project Structure

```
RegistrarBot/
‚îú‚îÄ‚îÄ src/                    # Backend source code
‚îÇ   ‚îú‚îÄ‚îÄ index.js           # Main Express server
‚îÇ   ‚îú‚îÄ‚îÄ routes/            # API route handlers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Test.js        # Chatbot API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ socket/            # Socket.io handlers
‚îÇ       ‚îî‚îÄ‚îÄ chatroom.js    # Chat room functionality
‚îú‚îÄ‚îÄ config/                # Configuration files
‚îÇ   ‚îî‚îÄ‚îÄ index.js           # Server configuration & logging
‚îú‚îÄ‚îÄ devtools/              # Frontend development tools
‚îÇ   ‚îî‚îÄ‚îÄ sandbox/           # Next.js frontend application
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/    # React components
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ pages/         # Next.js pages
‚îÇ       ‚îî‚îÄ‚îÄ config/            # Frontend configuration
‚îú‚îÄ‚îÄ package.json           # Backend dependencies
‚îî‚îÄ‚îÄ README.md
```

## ‚öôÔ∏è Quick Setup

### 1. Clone & Install
```bash
git clone https://github.com/Enzo0721/RegistrarBot.git
cd RegistrarBot
npm i
cd devtools/sandbox && npm i && cd ../..
```

> **üîß Port Configuration**: All ports are configured in the `.env` file at the project root. Copy `.env.example` to `.env` and customize as needed.

### 2. Environment Setup

**Configure Ports & Settings** (`.env` in root):

All port and configuration settings are managed in a **single `.env` file** at the project root.

```bash
# Copy the example file
cp .env.example .env

# Edit .env with your preferred settings
# All ports can be customized here!
```

**Key Configuration Variables:**
```env
# API Server
APP_HOST_PORT=3000      # Access API at http://localhost:3000
SERVER_PORT=5000        # Internal container port

# Database
DB_PORT=5432            # PostgreSQL port

# Sandbox (Next.js UI)
SANDBOX_HOST_PORT=3001  # Access UI at http://localhost:3001
```

See `.env.example` for complete documentation of all available settings.

### 3. Install Ollama & Model
```bash
curl -fsSL https://ollama.ai/install.sh | sh
ollama run qwen3
```

## üöÄ Running

### Option 1: Docker (Recommended)

**Main Application (Backend + Database):**
```bash
# From project root
docker-compose up -d --build

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

**Services & Ports** (default configuration):
- **Port 3000** (`APP_HOST_PORT`): RegistrarBot API Server (Express + Socket.IO)
  - Health Check: http://localhost:3000/health
  - API Docs (Swagger): http://localhost:3000/api/docs
  - Chat API: http://localhost:3000/api/v1/test/ask
- **Port 5432** (`DB_PORT`): PostgreSQL Database
  - Used internally by the app and Prisma
  - Connection: `postgresql://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}`

> **üí° Tip**: To change ports, edit the `.env` file before running `docker compose up`

**Sandbox (Frontend Development Tool):**
```bash
# From devtools/sandbox directory
cd devtools/sandbox
docker-compose up -d --build

# View logs
docker-compose logs -f
```

**Sandbox Ports** (default configuration):
- **Port 3001** (`SANDBOX_HOST_PORT`): Next.js Development Server
  - Web UI for testing the chatbot: http://localhost:3001
  - Hot reload enabled for frontend development

> **üí° Tip**: The sandbox uses the same `.env` file from the project root. Change `SANDBOX_HOST_PORT` to use a different port.

### Option 2: Local Development

**Start Ollama model:**
```bash
ollama run qwen3
```

**Backend:**
```bash
npm run dev
# Available at http://localhost:3001
```

**Frontend:**
```bash
cd devtools/sandbox
npm run dev
# Available at http://localhost:3000
```

### Option 3: NVIDIA Enroot (HPC/GPU Clusters)

For deploying on HPC systems with NVIDIA Enroot:

**Prerequisites:**
```bash
# Install Enroot (if not already installed)
# Follow: https://github.com/NVIDIA/enroot/blob/master/doc/installation.md

# Verify installation
enroot version
```

**Deploy to Enroot:**
```bash
# 1. Build and convert Docker images to Enroot format
# scripts are located in `registrarbot/scripts/`
registrarbot/scripts/deploy-enroot.sh

# 2. Source the configuration (generated by the deploy script)
source enroot-config.env

# 3. Start services
registrarbot/scripts/run-enroot.sh start

# Check status
registrarbot/scripts/run-enroot.sh status

# Stop services
registrarbot/scripts/run-enroot.sh stop
```

**Services & Access:**
- API Server: `http://localhost:3000` (configurable via `.env`)
- Sandbox UI: `http://localhost:3001` (configurable via `.env`)
- Database: Running in separate Enroot container

**Key Differences from Docker:**
- Each service runs as a separate Enroot container
- No automatic networking between containers (use localhost/host networking)
- Containers are managed individually via PIDs
- Images stored as `.sqsh` (squashfs) files

**Enroot Commands:**
```bash
# Start all services
./run-enroot.sh start

# Check service status
./run-enroot.sh status

# View logs
./run-enroot.sh logs

# Restart services
./run-enroot.sh restart

# Stop all services
./run-enroot.sh stop
```

**Configuration:**
- Main config: `.env` (same as Docker)
- Enroot-specific: `enroot-config.env` (auto-generated)
- Enroot runtime: `enroot.conf`

**Data Persistence:**
- Database: `~/registrarbot-data/postgres`
- Logs: `~/registrarbot-data/logs`
- Images: `~/.local/share/enroot/*.sqsh`

### Enroot Quick Start

Follow these exact steps to prepare, deploy and run RegistrarBot with Enroot. These are tuned for development/testing (host is a Linux/WSL environment).

1) Ensure prerequisites

```bash
# Install Enroot and helper tools
# On Ubuntu/Debian:
sudo apt-get update
sudo apt-get install -y squashfuse squashfs-tools debootstrap

# Verify Enroot is available
enroot version
```

2) Build the Docker images (locally)

```bash
# From project root
docker compose build
cd devtools/sandbox && docker compose build && cd -
```

3) Convert Docker images to Enroot format

```bash
# This script imports local Docker images into Enroot as .sqsh files
# (script moved to `registrarbot/scripts/`)
registrarbot/scripts/deploy-enroot.sh

# If you get "File already exists" errors, remove old images first:
rm -f ~/.local/share/enroot/*.sqsh
registrarbot/scripts/deploy-enroot.sh
```

4) Source runtime config and start services

```bash
source enroot-config.env
source .env
registrarbot/scripts/run-enroot.sh start
registrarbot/scripts/run-enroot.sh status
```

5) Inspect logs (useful when services exit)

```bash
tail -n +1 ~/registrarbot-data/logs/*.log
```

### Troubleshooting (Enroot)

- squashfuse missing: install `squashfuse` (see step 1). Without it Enroot cannot mount `.sqsh` images.
- Docker images missing: ensure `docker images` shows `registrarbot-app` and `postgres:15-alpine` before running `deploy-enroot.sh`.
- WSL path issues (Windows): prefer running Enroot on native Linux or WSL2 with proper permissions; use `dockerd://` import (script uses `dockerd://` by default).
- Container exits immediately: check logs at `~/registrarbot-data/logs/*.log` for runtime errors (missing env vars, permission problems).
- Stale PID files: remove `~/registrarbot-data/*.pid` and restart.

### Cleaning up Enroot artifacts

To remove Enroot images and runtime data locally:

```bash
./run-enroot.sh stop || true
rm -f ~/.local/share/enroot/*.sqsh
rm -rf ~/registrarbot-data
```

---

## üîß Customizing Ports & Configuration

All ports and settings are configured in the **`.env` file** at the project root.

### How to Change Ports

1. **Edit the `.env` file:**
```bash
# Example: Change API from port 3000 to 8080
APP_HOST_PORT=8080

# Example: Change database from 5432 to 5433
DB_PORT=5433

# Example: Change sandbox from 3001 to 3002
SANDBOX_HOST_PORT=3002
SOCKET_ORIGIN=http://localhost:3002
```

2. **Restart Docker containers:**
```bash
docker compose down
docker compose up -d
```

3. **Access updated ports:**
```bash
# API now at http://localhost:8080
curl http://localhost:8080/health

# Sandbox now at http://localhost:3002
```

### Configuration Reference

See `.env.example` for complete documentation. Key variables:

| Variable | Description | Default |
|----------|-------------|---------|
| `APP_HOST_PORT` | API server port on your machine | 3000 |
| `SERVER_PORT` | Internal container port | 5000 |
| `DB_PORT` | PostgreSQL port | 5432 |
| `SANDBOX_HOST_PORT` | Sandbox UI port | 3001 |
| `DB_USER` | Database username | myuser |
| `DB_PASSWORD` | Database password | mypassword |
| `DB_NAME` | Database name | registrarbot_db |

## üì° API Endpoints
======================- **GET** `/health` - Health check
- **POST** `/api/v1/test/ask` - Chat with bot
- **GET** `/api/docs` - Swagger documentation

## üîå Socket Events

- `joinRoom` - Join chat room
- `chatMessage` - Send/receive messages
- `userJoined`/`userLeft` - User notifications

## üóÑÔ∏è Database Management with Prisma Studio

Prisma Studio is a visual database browser that lets you view and edit your database data through a web interface.

**Starting Prisma Studio:**
```bash
# Local development (outside Docker)
npx prisma studio

# Access at: http://localhost:5555
```

**What Prisma Studio Does:**
- üìä **Browse Data**: View all tables and records in a visual interface
- ‚úèÔ∏è **Edit Records**: Add, update, or delete database entries
- üîç **Filter & Search**: Query your data with filters
- üîó **Relations**: Navigate relationships between tables

**Common Use Cases:**
- Inspect data after API calls
- Manually add test data
- Debug database issues
- Verify migrations worked correctly

**Note**: Prisma Studio connects to your database using the `DATABASE_URL` in your `.env` file. Make sure your database is running (via Docker or locally) before starting Studio.

## üêõ Troubleshooting

### Docker Issues
- **Docker daemon not running**: 
  - Start Docker Desktop on Windows
  - Enable WSL integration: Docker Desktop ‚Üí Settings ‚Üí Resources ‚Üí WSL Integration
  - Verify with: `docker ps`
- **Database connection issues**: Check logs with `docker-compose logs db`
- **Port conflicts**: Modify ports in `docker-compose.yml` if 3000, 3001, or 5432 are in use

### Local Development Issues
- **Port conflicts**: `npx kill-port 3001`
- **Ollama issues**: Ensure `ollama run qwen3` is running
- **Connection issues**: Check `.env` files and restart servers

### Enroot Issues
- **Enroot not found**: 
  ```bash
  # Install Enroot
  git clone https://github.com/NVIDIA/enroot.git
  cd enroot
  make install
  ```
- **Permission denied**: 
  - Ensure Enroot is properly configured: `enroot version`
  - Check `~/.config/enroot/.enrootrc` exists
  - May need `--root` flag for certain operations
- **Container won't start**: 
  - Check if images exist: `ls ~/.local/share/enroot/*.sqsh`
  - Re-run deployment: `./deploy-enroot.sh`
  - Check PIDs: `./run-enroot.sh status`
- **Database connection failed**: 
  - Ensure database container started: `./run-enroot.sh status`
  - Check if database port is accessible: `netstat -tuln | grep 5432`
  - Wait a few seconds after starting database before starting app
- **Port already in use**: 
  - Change ports in `.env` file
  - Stop conflicting services: `./run-enroot.sh stop`
  - Check for orphaned processes: `ps aux | grep enroot`

## üìÑ License

MIT License - see [LICENSE](LICENSE) file for details.